---
title: "Bove Meta Analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
This version of the script was last committed to GitHub on 25 July 2019
```{r start, message=FALSE}
setwd("/Users/Colleen/Dropbox/Boston_Experiment/Manuscript3_metaanalysis/Code/Bove_MetaAnalysis")
df <- read.csv("effectsize_09May19.csv") 
df <- subset(df, author !="Jury_CALC")
df$units <- NULL
calc <- read.csv("effectsize_23July19.csv") 
calc <- subset(calc, units !="N")
calc$num <- 1:nrow(calc) # just helpful for the data manipulation
calc$units <- NULL

df$cite <- paste(df$author, df$year, sep = " ")

library("metafor")
library("MAd")
library("ggplot2")
library("tidyr")
library("plyr")
library("lme4")
library("tidystats")
theme_set(theme_bw())
dodge<-position_dodge(0.2)
seed = 7 #seed to make results replicatable
```

# Create the Effect Size and Variance Data Frame
### Set up the dataframe of effect size and variance for acidification and warming ONLY studies

Effect size (yi) and variance (vi). Variables with a 1 are control, 3 represent acidification, 4 are warming, and 6 is the interaction studies. 'm' is the mean calcification rate, 'n' is sample size, and 's' is the standard error of mean calcification rate per study. 

```{r ES1, echo=TRUE, warning=FALSE, message=FALSE, tidy=TRUE}
setwd("/Users/Colleen/Dropbox/Boston_Experiment/Manuscript3_metaanalysis/Code/Bove_MetaAnalysis/Bove_MetaAnalysis_22Jul19_files")
# calculate ES and variance for ocean acidification
ES.oa<-escalc(measure="ROM", m1i=cm1, m2i=am3, sd1i=s1, sd2i=s3, n1i=n1, n2i=n3,  method="REML", data=df)

# calculate ES and variance ES for ocean warming
ES.ow<-escalc(measure="ROM", m1i=cm1, m2i=wm4, sd1i=s1, sd2i=s4, n1i=n1, n2i=n4,  method="REML", data=df)

#create DF of calculated variables of OA
acid<-data.frame("cm1"=ES.oa$cm1,"yi.a"=ES.oa$yi,"vi.a"=ES.oa$vi)

# merge together warming and acid DF 
ES.full<-merge(ES.ow,acid,by="cm1")
ES.full<-rename(ES.full,c("yi"="yi.w","vi"="vi.w"))
ES.full<-ES.full[order(ES.full$cite), ]
ES.full$yi.w<-(ES.full$yi.w)*-1
ES.full$yi.a<-(ES.full$yi.a)*-1
```

Calculate the standard deviation of the calcification mean (sd) and then the pooled standard deviation (S).

```{r sd}
# calculate sd for all 
ES.full$sd1<-ES.full$s1*sqrt(ES.full$n1)
ES.full$sd3<-ES.full$s3*sqrt(ES.full$n3)
ES.full$sd4<-ES.full$s4*sqrt(ES.full$n4)
ES.full$sd6<-ES.full$s6*sqrt(ES.full$n6)

# calculate S for all treatments
ES.full$Sa<-sqrt((ES.full$sd1^2/ES.full$n1)+(ES.full$sd3^2/ES.full$n3))
ES.full$Sw<-sqrt((ES.full$sd1^2/ES.full$n1)+(ES.full$sd4^2/ES.full$n4))
ES.full$Si<-sqrt((ES.full$sd1^2/ES.full$n1)+(ES.full$sd6^2/ES.full$n6))
```

### Calculate ES and variance on the interaction studies
These equations were taken from Harvey et al. 2013 (https://dx.doi.org/10.1002%2Fece3.516) 

```{r ESinter}
# calculate ES using Harvey et al equations for acidification, warming, and interaction studies
ES.full$lnRRa<-((ES.full$am3-ES.full$cm1)/ES.full$Sa)
ES.full$lnRRt<-((ES.full$wm4-ES.full$cm1)/ES.full$Sw)
ES.full$yi.i<-((ES.full$m6-ES.full$wm4)-(ES.full$am3-ES.full$cm1))/(2*ES.full$Si)

# calculate V for interaction studies ONLY
ES.full$vi.i<-(1/ES.full$n1)+(1/ES.full$n3)+(1/ES.full$n4)+(1/ES.full$n6)+((ES.full$yi.i^2)/(2*(ES.full$n1+ES.full$n3+ES.full$n4+ES.full$n6)))
```

Finally, write the new data frame as a new CSV file for faster use.
```{r writeCSV}
write.csv(ES.full,file="ES.full_10May19.csv")
```

### Create long version of ES dataframe
I am using the metafor calculated ES and variance for acidification and wamring alone, but the Harvey et al calculated ES and variance for the interactions... I am not sure if this is the best method? 
```{r start2}
# read in the saved CSV and then removed any unneeded columns
df<-read.csv("ES.full_10May19.csv")
df<-df[,-c(2, 12, 13, 16:18, 20:22, 24:26, 34:42)] #remove any unneeded columns

```

```{r datamanip}
#subset df for variance (v) values only as new df
df2b<-subset(df, select=c(X,vi.i,vi.a,vi.w))

#subset df to remove only variance (v) values as another new df
df.m <-subset(df, select=-c(vi.i,vi.a,vi.w))

# this creates df with treat and V as column headers in long format
df2b<-gather(df2b, treat, v,vi.i:vi.w)

#substitute y for v for merge later
df2b$treat<-gsub('v','y', df2b$treat)

#creates another long format df with treat and Y as headers (of Y values)
df.m <-gather(df.m, treat, y,yi.w:yi.i)
df.m $treat<-as.factor(df.m $treat)

#merge two df into one
df2<-merge(df.m, df2b, by=c("X", "treat"))

#remove any NAs
#df2<-na.omit(df2)
df2$study <- paste(df2$author, df2$year, sep = "_")
df2$X<-NULL
head(df2)
```
Here I am going ahead and calculating the magnitude difference for pCO2 and temperature treatments
```{r}
df2$mag.p <- df2$a.pco2 - df2$c.pco2
df2$mag.t <- df2$w.temp - df2$c.temp

df2$mag.cent.p <- df2$mag.p - 127 #make a centered around 0 column
df2$mag.cent.t <- df2$mag.t - 1.0 #make a centered around 0 column
```

#Fitting models to each treatment

```{r rma}
# subset data by treatment
OW<-subset(df2, treat=="yi.w")
OA<-subset(df2, treat=="yi.a")
IN<-subset(df2, treat=="yi.i")

# fit model to each treatment
ow<-rma(y,v,data=OW)
oa<-rma(y,v,data=OA)
both<-rma(y,v,data=IN)
```

###View OA model output with forest and funnel plots
```{r oa, echo=FALSE, fig.height = 11, fig.width = 9, fig.align = "center"}
oa
pdf(file='OA_forest_18Jun19.pdf', width=9, height=11)
forest(oa, slab=paste(OA$cite, OA$spec, OA$site, sep=" - "), order=order(OA$cite))
dev.off()
forest(oa, slab=paste(OA$cite, OA$spec, OA$site, sep=" - "), order=order(OA$cite))
```
```{r oa2, echo=FALSE, fig.align = "center"}
pdf(file='OA_funnel_18Jun19.pdf', width=6,height=5.5)
funnel(oa)
dev.off()
funnel(oa)
```

###View OW model output with forest and funnel plots
```{r ow, echo=FALSE, fig.height = 11, fig.width = 9, fig.align = "center"}
ow
pdf(file='OW_forest_18Jun19.pdf', width=9.5, height=10)
forest(ow, slab=paste(OW$cite, OW$spec, OW$site, sep=" - "), order=order(OW$cite))
dev.off()
forest(ow, slab=paste(OW$cite, OW$spec, OW$site, sep=" - "), order=order(OW$cite))
```
```{r ow2, echo=FALSE, fig.align = "center"}
pdf(file='OW_funnel_18Jun19.pdf', width=6,height=5.5)
funnel(ow)
dev.off()
funnel(ow)
```

###View interaction model output with forest and funnel plots
```{r both, echo=FALSE, fig.height = 9, fig.width = 9, fig.align = "center"}
both
pdf(file='interaction_forest_18Jun19.pdf', width=9.5, height=9)
forest(both, slab=paste(IN$cite, IN$spec, IN$site, sep=" - "), order=order(IN$cite))
dev.off()
forest(both, slab=paste(IN$cite, IN$spec, IN$site, sep=" - "), order=order(IN$cite))
```
```{r both2, echo=FALSE, fig.align = "center"}
pdf(file='interaction_funnel_18Jun19.pdf', width=5, height=5)
funnel(both)
dev.off()
funnel(both)
```


#Fitting models by region (Florida and Belize only)
Remove regions so that only Florida and Belize studies remain
```{r region1}
df2a<-subset(df2, region!="Curacao")
df2a<-subset(df2a, region!="Little Cayman")
df2a<-subset(df2a, region!="Mexico")

# OA subset
OA2<-subset(df2a, treat=="yi.a")

# OW subset
OW2<-subset(df2a, treat=="yi.w")

# Interaction subset
IN2<-subset(df2a, treat=="yi.i")

```

Fit models to each treatment by region
```{r regionRMA, warning=FALSE}
# acidification by warming
oa.r<-rma(y,v,mods=~region, data=OA2)

# warming by regions
ow.r<-rma(y,v,mods=~region, data=OW2)

# interactions by region
in.r<-rma(y,v,mods=~region, data=IN2)
```

### View region-specific model output per treatment
**Ocean acidification**
```{r OAregion, echo=FALSE}
oa.r
```

**Ocean warming**
```{r OWregion, echo=FALSE}
ow.r
```

**Interaction of acidification and warming**
```{r intregion, echo=FALSE}
in.r
```

#Fitting mixed effects models 
Modify dataframe to remove and missing values and set seed/interations
```{r fullModel}
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

df2 <- completeFun(df2, "y")
head(df2)
```

### This is the global model by treatment only
```{r}
global.mod <- rma.mv(y,v, mods = ~ treat, random = list(~ (1|study), ~ (1|species)), data = df2) 
summary(global.mod) # view summary output of model
AIC(global.mod) # check the AIC

preds <- as.data.frame(predict(global.mod, newdata = df2))[,c(1,3:4)] # pull the mean and CI with the predict function
global.out <- cbind(df2, preds) # add columns to existing df for global output
```

###Plot mean and CI
```{r echo=FALSE}
global.out$treat <- factor(global.out$treat, levels = c("yi.a","yi.w","yi.i"))
global.out$wt <- 1/(global.out$v)

global_CI <- 
  ggplot(global.out)+
  theme(panel.grid.major=element_blank(), legend.position="none", panel.grid.minor=element_blank(), panel.background=element_blank())+
  theme(axis.line=element_line(color="black"))+
  theme(legend.key=element_blank())+
  ylab("Mean effect size (LnRR)")+
  xlab("")+
  scale_x_discrete(labels=c("yi.a" = "acidification", "yi.w" = "warming", "yi.i" = "interaction"))+
  geom_hline(yintercept=0, linetype=2, colour="black")+
  geom_point(aes(x = treat, y = y, size = wt),  colour="grey", data = global.out, alpha = 0.5, position=position_jitter(width=0.1))+
  #geom_errorbar(aes(ymin=lb, ymax=ub, width=0.1), size=0.6)+
  geom_linerange(aes(x = treat, ymin=ci.lb, ymax=ci.ub), size=0.8)+
  geom_point(aes(x = treat, y = pred), size=10, shape=95, colour="black")+
  ylim(-1.6,0.6)
global_CI

pdf("global_CI_22July19.pdf", width=6, height=4)
global_CI
dev.off()
```

### This is the model by region (Florida and Belize only) for all treatments
```{r}
df2a<-subset(df2, region!="Curacao")
df2a<-subset(df2a, region!="Little Cayman")
df2a<-subset(df2a, region!="Mexico")

region.mod <- rma.mv(y,v, mods = ~ treat * region, random = list(~ (1|study), ~ (1|species)), data = df2a)
summary(region.mod) # view summary output of model
AIC(region.mod) # check the AIC

preds2 <- as.data.frame(predict(region.mod, newdata = df2))[,c(1,3:4)] # pull the mean and CI with the predict function
region.out <- cbind(df2a, preds2) # add columns to existing df for global output
```

###Plot mean and CI by regions
```{r echo=FALSE}
region.out$treat <- factor(region.out$treat, levels = c("yi.a","yi.w","yi.i"))
region.out$wt <- 1/(region.out$v)

region_CI <- ggplot(region.out)+
  theme(panel.grid.major=element_blank(), legend.position="none", panel.grid.minor=element_blank(), panel.background=element_blank())+
  theme(axis.line=element_line(color="black"))+
  theme(legend.key=element_blank())+
  ylab("Mean effect size (LnRR)")+
  xlab("")+
  scale_x_discrete(labels=c("yi.a" = "acidification", "yi.w" = "warming", "yi.i" = "interaction"))+
  geom_hline(yintercept=0, linetype=2, colour="black")+
  geom_point(aes(x = treat, y = y, size = wt),  colour="grey", data = region.out, alpha = 0.5, position=position_jitter(width=0.1))+
  #geom_errorbar(aes(ymin=lb, ymax=ub, width=0.1), size=0.6)+
  geom_linerange(aes(x = treat, ymin=ci.lb, ymax=ci.ub), size=0.8)+
  geom_point(aes(x = treat, y = pred), size=10, shape=95, colour="black")+
  facet_wrap(~region)
region_CI

pdf("region_CI_22July19.pdf", width=8, height=4)
region_CI
dev.off()
```

**Everything above this point is updated and I am proceeding as if they are "final" so please let me know if there are any updates you have!**

# Running magnitude analyses

### Ocean warming
Manipulate original df (calc) for a column of (1) treatment, (2) the resulting mean rate, (3) and the SE of the mean <- also only doing this for warming studies
```{r}
head(calc)
calc.w<-calc[,-c(15:18, 23:27)] #remove columns not needed for warming analysis

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
} # remove and NA columns from warming column
calc.w <- completeFun(calc.w, "wm4")

#subset calc for calcication rates
calc.b<-subset(calc.w, select=c(num, cm1, wm4))
# create df with treat and rate as column headers in long format
calc.b<-gather(calc.b, treat, rate, cm1:wm4)
# rename for useful treatment names
calc.b$treat<-gsub('cm1','control', calc.b$treat)
calc.b$treat<-gsub('wm4','warm', calc.b$treat)

#subset calc for SE
calc.c<-subset(calc.w, select=c(num, s1, s4))
# create df with treat and SE as column headers in long format
calc.c<-gather(calc.c, treat, SE, s1:s4)
# rename for useful treatment names
calc.c$treat<-gsub('s1','control', calc.c$treat)
calc.c$treat<-gsub('s4','warm', calc.c$treat)

#subset calc to remove only columns from above
calc.d <-subset(calc.w, select=-c(s1 ,s4 ,cm1, wm4, c.pco2, n1, n4))
# this creates df with treat and V as column headers in long format
calc.d<-gather(calc.d, treat, temp, c.temp:w.temp)
# rename for useful treatment names
calc.d$treat<-gsub('c.temp','control', calc.d$treat)
calc.d$treat<-gsub('w.temp','warm', calc.d$treat)

#merge dfs into one, final warming
calc.m<-merge(calc.d, calc.b, by=c("num", "treat"))
calc.warm<-merge(calc.m, calc.c, by=c("num", "treat"))

# create column for weight
calc.warm$wt <- 1 / calc.warm$SE

# create study column
calc.warm$study <- paste(calc.warm$author, calc.warm$year, sep = "_")

# center temps
mean(calc.warm$temp)
calc.warm$cent.temp <- calc.warm$temp - mean(calc.warm$temp)

calc.warm$cent.pco2 <- rep("NA", 66)
head(calc.warm)
```

```{r}
calc.warm$scale.temp <- scale(calc.warm$temp, center = TRUE, scale = TRUE)

warm.rate.mod <- lmer(rate ~ scale.temp + (1|study) + (1|spec), weights = 1/SE, data = calc.warm) 
summary(warm.rate.mod) # view summary output of model
anova(warm.rate.mod)

warm.pred <- as.data.frame(predict(warm.rate.mod, newdata = calc.warm))
colnames(warm.pred)[1] <- "mean"
warm.df <- cbind(calc.warm, warm.pred)

plot(warm.df$temp, warm.df$mean)

```

###Plot the slope/intercept of OW model on data
```{r echo=FALSE}
global_OW_calc <- 
  ggplot(warm.df, aes(x=scale.temp, y=mean, colour=region))+
  theme(panel.grid.major=element_blank(), legend.position="bottom", panel.grid.minor=element_blank(), panel.background=element_blank())+
  theme(axis.line=element_line(color="black"))+
  theme(legend.key=element_blank())+
  geom_abline(slope = coef(summary(warm.rate.mod))[2,1], intercept = coef(summary(warm.rate.mod))[1,1])+
  #geom_line(data = warm.df, aes(y = mean), size = 1)+
  ylab("Calcification rate")+
  xlab("Temperature")+
  geom_point(size=4, aes(shape = region))
global_OW_calc

pdf("global_OW_calc_25Jul19.pdf", width=8, height=5)
global_OW_calc
dev.off()
```


### Ocean aciding
Manipulate original df (calc) for a column of (1) treatment, (2) the resulting mean rate, (3) and the SE of the mean <- also only doing this for aciding studies
```{r}
calc.a<-calc[,-c(19:27)] #remove columns not needed for aciding analysis

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
} # remove and NA columns from aciding column
calc.a <- completeFun(calc.a, "am3")

#subset calc for calcication rates
calc.x<-subset(calc.a, select=c(num, cm1, am3))
# create df with treat and rate as column headers in long format
calc.x<-gather(calc.x, treat, rate, cm1:am3)
# rename for useful treatment names
calc.x$treat<-gsub('cm1','control', calc.x$treat)
calc.x$treat<-gsub('am3','acid', calc.x$treat)

#subset calc for SE
calc.y<-subset(calc.a, select=c(num, s1, s3))
# create df with treat and SE as column headers in long format
calc.y<-gather(calc.y, treat, SE, s1:s3)
# rename for useful treatment names
calc.y$treat<-gsub('s1','control', calc.y$treat)
calc.y$treat<-gsub('s3','acid', calc.y$treat)

#subset calc to remove only columns from above
calc.d <-subset(calc.a, select=-c(s1 ,s3 ,cm1, am3, c.temp, n1, n3))
# this creates df with treat and V as column headers in long format
calc.d<-gather(calc.d, treat, pco2, c.pco2:a.pco2)
# rename for useful treatment names
calc.d$treat<-gsub('c.pco2','control', calc.d$treat)
calc.d$treat<-gsub('a.pco2','acid', calc.d$treat)

#merge dfs into one, final aciding
calc.m<-merge(calc.d, calc.x, by=c("num", "treat"))
calc.acid<-merge(calc.m, calc.y, by=c("num", "treat"))

# create column for weight
calc.acid$wt <- 1 / calc.acid$SE

# create study column
calc.acid$study <- paste(calc.acid$author, calc.acid$year, sep = "_")

# center temps
mean(calc.acid$pco2)
calc.acid$cent.pco2 <- calc.acid$pco2 - mean(calc.acid$pco2)
calc.acid$cent.temp <- rep("NA", 66)
```

```{r}
calc.acid$scale.pco2 <- scale(calc.acid$pco2, center = TRUE, scale = TRUE)

#acid.rate.mod <- lmer(rate ~ scale.pco2  + I(scale.pco2^2) + (1|study) + (1|spec), weights = 1/SE, data = calc.acid) 
acid.rate.mod <- lmer(rate ~ scale.pco2 + (1|spec), weights = 1/SE, data = calc.acid) 
summary(acid.rate.mod) # view summary output of model

acid.pred <- as.data.frame(predict(acid.rate.mod, newdata = calc.acid))
colnames(acid.pred)[1] <- "mean"
acid.df <- cbind(calc.acid, acid.pred)

```

